define(["jquery","underscore"],function(a,b){function c(c,d,e,f){function g(a){function g(a,b,d){var e="[JSSDK] response status "+a.status,f=0===a.status?"F":"B";e+=" error Type "+f+" random code "+j,h.reportError(e,c,null,null,null,function(){d&&d(a,b,j)})}var j=("0000"+b.random(1,99999)).slice(-5),k="t="+(new Date).getTime()+"&uid="+h.userId+"&code="+j;c+=(c.indexOf("?")>=0?"&":"?")+k;var l=new XMLHttpRequest;if(l.open("POST",c),l.setRequestHeader("Content-Type","application/json;charset=UTF-8"),h.shellAppFlag&&(l.setRequestHeader("X-MOBAGE-SHELLAPP",1),a)){var m=a.getVersionName(),n=Number(a.getVersionCode());"1.0"===m&&n&&n>0&&(m+=".0."+n),l.setRequestHeader("X-MOBAGE-SHELLAPP-VERSION",m)}l.setRequestHeader("X-VERSION",h.version),l.onreadystatechange=function(){if(4===l.readyState){if(200<=l.status&&l.status<300){var a=l.response;i.resolve(a),e&&e(a)}else{var b=l.statusText;i.reject(b),g(l,b,f)}l.onreadystatechange=new Function}},l.send(JSON.stringify(d))}var h=window.Game,i=new a.Deferred;return h.shellAppFlag?require(["lib/shellapp"],function(a){g(a)}):g(),i.promise()}function d(a){a!==f&&require(["util/navigate"],function(b){var c=0===a.indexOf("#")?a:g;b.hash(c,{refresh:!0})})}var e="mobage",f="null",g="#top",h="grbl",i="1",j=!1,k=!1,l=null,m=null,n=null,o=null,p={},q={},r=q.callAfterReady=function(a){a&&(k?a():document.addEventListener("mobageReady",function(){k=!0,a()}))};q.requireOnceJSSDKClient=function(a){if(a&&!j){j=!0;var b=document.createElement("script");b.type="text/javascript",b.async=!0,b.src=a,document.getElementsByTagName("script")[0].parentNode.appendChild(b)}},q.mobageInit=function(a){return a?void r(function(){if(l!==a.clientId||m!==a.redirectUri){l=a.clientId,m=a.redirectUri;try{window.mobage.init(a)}catch(b){l=null,m=null}}}):null},q.mobageGetConnectedStatus=function(b,c,d){var e=new a.Deferred;return r(function(){window.mobage.oauth.getConnectedStatus(b,function(a,b){b?(e.resolve(b),c&&c(b)):(e.reject(a),d&&d(a))})}),e.promise()};var s=q.mobageConnect=function(c,d,e){var f=new a.Deferred;return c=b.defaults(c,{customTheme:h,appearanceVersion:i}),r(function(){window.mobage.oauth.connect(c,function(a,b){a?(f.reject(a),e&&e(a)):(f.resolve(b),d&&d(b))})}),f.promise()},t=q.login=function(a,e,f,g){var h=window.Game,i=e&&e.response||{},j={code:i.code,state:i.state,session_state:i.session_state},k=a&&a.redirectUri||m;return b.isUndefined(f)&&(f=d),b.isUndefined(g)&&(g=function(a,b,c){if(h.view)h.view.trigger("data_error",[a.status,c]);else{var d=h.message.connectionError;alert(d)}}),c(k,j,f,g)},u=q.tryLogin=function(c,e,f,g){b.isUndefined(f)&&(f=d);var h=new a.Deferred;return t(c,e,function(a){"#authentication/failed_empty"===a||"#authentication/failed_exist"===a?(h.reject(),g&&g()):(h.resolve(),f&&f(a))},function(a,b,c){h.reject(),g&&g()}),h.promise()},v=(q.singleLogin=function(b,c,d){var e=new a.Deferred;return s(b,function(a){t(b,a,c,d).done(function(a){e.resolve(a)}).fail(function(a){e.reject(a)}).always(function(){var b=a&&a.response&&a.response.session_state;b&&y(b)})},function(a){e.reject(a)}),e.promise()},q.trySingleLogin=function(b,c,d){var e=new a.Deferred;return s(b,function(a){u(b,a,c,d).done(function(a){e.resolve(a)}).fail(function(a){e.reject(a)}).always(function(){var b=a&&a.response&&a.response.session_state;b&&y(b)})},function(a){e.reject(a)}),e.promise()}),w=q.mobageLogout=function(b,c,d){z().done(function(){var e=new a.Deferred;return r(function(){window.mobage.oauth.logout(b,function(a,b){a?(e.reject(a),d&&d(a)):(e.resolve(b),c&&c(b))})}),e.promise()})},x=q.logout=function(a,e,f){z().done(function(){return b.isUndefined(e)&&(e=d),b.isUndefined(f)&&(f=null),c("logout",a,e,f)})};q.singleLogout=function(b,c,d){var e=new a.Deferred;return w(b,function(a){x(b,c,d).done(function(a){e.resolve(a)}).fail(function(a){e.reject(a)})},function(a){e.reject(a)}),e.promise()};q.mobageSubscribeLogin=function(a,c){b.isUndefined(c)&&(c=function(b){v({state:a})}),r(function(){if(n!==a){n=a;var b="oauth.loginRequired",d=p[b];d&&window.mobage.event.unsubscribe(d),p[b]=window.mobage.event.subscribe(b,function(){c&&c(b)})}})};var y=q.mobageSubscribeLogout=function(a,c){b.isUndefined(c)&&(c=function(b){x({platform:e,session_state:a})}),r(function(){if(o!==a){o=a;var b="oauth.sessionStateChange",d=p[b];d&&window.mobage.event.unsubscribe(d),p[b]=window.mobage.event.subscribe(b,a,function(a){"changed"===a&&c&&c(b)})}})},z=q.checkAbilityToLogout=function(){function b(a){a.get("result")?c.resolve():(require(["view/popup","util/language-message"],function(a,b){var c=new a({className:"pop-cannot-logout",title:b.getMessage("logout_error_01"),body:b.getMessage("logout_error_02"),flagBtnClose:1,flagBtnOk:0});c.render().popShow()}),c.reject())}var c=a.Deferred();return Game.ua.isMbga()?(require(["model/token-data"],function(a){var c=new(a.extend({urlRoot:Game.baseUri+"logout/logout_check"}));c.stopListening(c,"sync"),c.listenToOnce(c,"sync",b),c.fetch()}),c.promise()):c.resolve().promise()};return q});