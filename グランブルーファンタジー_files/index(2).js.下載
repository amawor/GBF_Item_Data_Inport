define(["backbone","util/local-storage","lib/andapp","lib/iscroll"],function(a,b,c){var d,e,f="gbf_pcsbm",g="gbf_already_read",h=function(){},i=a.View.extend({el:"#submenu",state:{},events:{"tap .btn-submenu-control":"toggleSubmenu","tap .btn-sub-chat":"showChat","tap .btn-sub-setting":"showSetting","tap .btn-sub-help":"showHelp","tap .btn-sub-comic":"showComic","tap .btn-sub-beginnercomic":"showBeginnerComic"},initialize:function(){Game.submenu.contentView=null,d=b.getObject(f),this.notificationData=this.getSubmenuNotificationData(),d?(this.state=b.getObject(f),this.state.is_open&&(this.$el.addClass("open"),this.switchCurrent(this.state.current))):(this.state={is_open:!1,current:"chat"},b.setObject(f,this.state)),this.chceckNotification(),this.listenReadEvent(),$("#submenu").trigger("finishInitializing")},listenReadEvent:function(){for(var a=this,b=["chat","help","comic","beginnercomic"],c=[],d=0,e=b.length;e>d;d++){c[d]=this.$el.find(".btn-sub-"+b[d]);var f=b[d]+"Open";c[d].off(f).on(f,{category:b[d]},function(b,c){var d;_.isUndefined(c)===!1?(d=+c||0,a.notificationData[b.data.category]=d):d=a.notificationData[b.data.category],a.updateLocalStorageObject(g,b.data.category,d),a.chceckNotification()})}},chceckNotification:function(){var a=b.getObject(g);this.$el.find(".btn-sub-category").removeClass("notification");var c=this.$el.find(".btn-sub-chat"),d=this.notificationData.chat,e=this.$el.find(".btn-sub-help"),f=this.notificationData.help,h=this.$el.find(".btn-sub-comic"),i=this.notificationData.comic,j=this.$el.find(".btn-sub-beginnercomic"),k=this.notificationData.beginnercomic;return!a||_.isUndefined(a.chat)||_.isUndefined(a.help)||_.isUndefined(a.comic)||_.isUndefined(a.beginnercomic)?(a={chat:d,help:f,comic:i,beginnercomic:k},void b.setObject(g,a)):(d!==+a.chat&&c.addClass("notification"),f!==+a.help&&e.addClass("notification"),i!==+a.comic&&h.addClass("notification"),void(k!==+a.beginnercomic&&j.addClass("notification")))},getSubmenuNotificationData:function(){var a={};return["chat","help","comic","beginnercomic"].forEach(function(b){var c=this.$el.find(".btn-sub-"+b),d=+c.data("new-"+b+"-num")||0;a[b]=d}.bind(this)),a},move:function(a){$("#submenu").removeClass("wrapper-white wrapper-beige"),$("#loading-sm").css({display:"block"}),$("#cnt-submenu-contents").css({overflow:"hidden"}),Game.submenu.contentView&&Game.submenu.contentView.content_close(),Game.submenu.contentView instanceof h&&Game.submenu.contentView.destroy(),this.state.current=a,b.setObject(f,this.state)},toggleSubmenu:function(a){return _.isUndefined(a)||Game.submenu.contentView?(this.$el.toggleClass("open"),this.state.is_open=!this.state.is_open,b.setObject(f,this.state),this.trigger("toggleSubmenu",this.state.is_open),void(Game.ua.isAndApp()===!0&&c.toggleWindow(this.state.is_open))):void this.switchCurrent(this.state.current)},shouldOpenNewPage:function(a){return!(this.state.current===a&&Game.submenu.contentView)},showChat:function(){var a=this;return this.shouldOpenNewPage("chat")===!1?void this.toggleSubmenu():(this.state.is_open===!1&&this.toggleSubmenu(),this.updateLocalStorageObject(g,"chat",this.notificationData.chat),this.chceckNotification(),this.destroyIScroll(),void("chat"===a.state.current&&Game.submenu.contentView instanceof h||(a.move("chat"),e||(e='<div id="submenu-general-chat">'+_.template($("#tpl-general-chat").html())()+"</div>"),require(["view/submenu/chat/index"],function(b){Game.submenu.contentView instanceof b==!1&&(h=b,a.$el.find("#cnt-submenu-contents").html(e),Game.submenu.contentView=new b)}),$("#loading-sm").css({display:"none"}),$("#cnt-submenu-contents").css({overflow:"visible"}))))},showSetting:function(a){if(this.shouldOpenNewPage("setting")===!1&&"index"===b.getObject("gbf_pcsbm:open_setting_page"))return void this.toggleSubmenu();this.state.is_open===!1&&this.toggleSubmenu(),this.move("setting"),"undefined"!=typeof a&&b.setObject("gbf_pcsbm:open_setting_page","index");var c=b.getObject("gbf_pcsbm:open_setting_page");this.initContentView("view/submenu/setting/index",{category:null,setted:null,items:c})},showHelp:function(){return this.shouldOpenNewPage("help")===!1?void this.toggleSubmenu():(this.state.is_open===!1&&this.toggleSubmenu(),this.updateLocalStorageObject(g,"help",this.notificationData.help),this.chceckNotification(),this.move("help"),void this.initContentView("view/submenu/help/index"))},showComic:function(){return this.shouldOpenNewPage("comic")===!1?void this.toggleSubmenu():(this.state.is_open===!1&&this.toggleSubmenu(),this.updateLocalStorageObject(g,"comic",this.notificationData.comic),this.chceckNotification(),this.move("comic"),void this.initContentView("view/submenu/comic/index"))},showBeginnerComic:function(){return this.shouldOpenNewPage("beginnercomic")===!1?void this.toggleSubmenu():(this.state.is_open===!1&&this.toggleSubmenu(),this.updateLocalStorageObject(g,"beginnercomic",this.notificationData.beginnercomic),this.chceckNotification(),this.move("beginnercomic"),void this.initContentView("view/submenu/beginnercomic/index"))},switchCurrent:function(a){switch(a){case"chat":this.showChat();break;case"setting":this.showSetting();break;case"help":this.showHelp();break;case"comic":this.showComic();break;case"beginnercomic":this.showBeginnerComic();break;default:this.showChat()}},initContentView:function(a,b){var c=this;Game.submenu.contentView&&Game.submenu.contentView.content_close(),this.contentsScroller&&this.contentsScroller.scrollTo(0,0,0),require([a],function(a){Game.submenu.contentView=new a(b),c.stopListening().listenToOnce(Game.submenu.contentView,"changeContentView",function(a){clearTimeout(c.scrollTimer),c.state.current="secondView",c.initContentView(a.path,a.option)}),c.listenTo(Game.submenu.contentView,"forwardContentView",function(){c.state.current="secondView"}),c.listenTo(Game.submenu.contentView,"finishRendering completeLoadStyle",function(){c.initIScroll(!0)}).listenTo(Game.submenu.contentView,"autoScrollTo",function(a){c.contentsScroller.refresh(),_.isUndefined(a.el)?c.contentsScroller.scrollTo(0,a.pos,a.duration):c.contentsScroller.scrollToElement(a.el,a.duration)}),c.scrollTimer=setTimeout(function(){c.initIScroll(!1)},500)})},initIScroll:function(a){if(a===!0&&clearTimeout(this.scrollTimer),!this.contentsScroller){var b=!(Game.ua.isPcPlatform()||Game.ua.isChromeApp()||Game.ua.isAndApp());this.contentsScroller=new IScroll("#prt-submenu-contents",{mouseWheel:!0,preventDefault:b}),$("#prt-submenu-contents").on("touchmove",function(a){a.preventDefault()}).on("tap",function(a){a.preventDefault()})}this.contentsScroller.refresh()},destroyIScroll:function(){this.contentsScroller&&(clearTimeout(this.scrollTimer),this.contentsScroller.destroy(),this.contentsScroller=null,$("#cnt-submenu-contents").removeAttr("style").unbind())},updateLocalStorageObject:function(a,c,d){var e=b.getObject(a)||{};e[c]=d,b.setObject(a,e)}}),j={GUILD:0,COOP:1,RAID:2},k="raid_multi",l="raid_semi",m="coopraid",n="room",o="lobby",p="roomIndex";return a.history.on("route",function(a,b){if(h&&Game.submenu.contentView instanceof h){var c=Game.submenu.contentView;if(c.enabledFlag===!1){var d=a&&a.prefix===m&&b===n,e=a&&a.prefix===o&&b===p,f=b===k||b===l;c.currentChannel===j.COOP&&(d||e)?c.changeChannelToCoop():c.currentChannel===j.RAID&&f&&c.changeChannelToRaid()}}}),i});