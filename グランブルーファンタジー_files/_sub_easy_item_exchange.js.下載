define(["backbone","model/content","view/content","model/data","model/token-data","model/sound","view/popup","view/shop/popup_purchase_failure","constant/item","util/language","util/language-message"],function(a,b,c,d,e,f,g,h,i,j,k){var l=1,m={treasure:0,pendant:1,casino:2,arcarum:3,moon:4,stone:5},n=999999,o={EVOLUTION:"evolution",ITEM:"item",SHOP:"shop",PARTY:"party",AROUSAL:"arousal",HIDDENWEAPON:"hiddenweapon",BULLET:"bullet",COMPANIONPARTS:"companionparts",SHIELD:"shield",DOMAIN:"domain_evoker",ITEM_AROUSAL:"item_arousal",REPLICARD:"replicard",FAMILIAR:"familiar",PERFECTIONPROOF:"perfectionproof"},p={detailTitleId:"easy_exchange_detail_pop_title",detailMethodName:"rest/item/detail/entrance",detailPostData:{},receivePresentConfirmMethod:"rest/item/detail/receive_confirm/",receivePresentMethod:"rest/item/detail/receive_present"},q={evolution:{npc:{detailTitleId:"evolution_npc_6",detailMethodName:"rest/evolution/npc_evolution_item_detail",detailPostData:{npc_id:""},sendType:"fetch",receivePresentConfirmMethod:"rest/evolution/receive_confirm/",receivePresentMethod:"rest/evolution/receive_present"},weapon:{detailTitleId:"evolution_weapon_9",detailMethodName:"rest/evolution/weapon_evolution_item_detail",detailPostData:{weapon_id:""},sendType:"save",receivePresentConfirmMethod:"rest/evolution/receive_confirm/",receivePresentMethod:"rest/evolution/receive_present"},summon:{detailTitleId:"evolution_summon_10",detailMethodName:"rest/evolution/summon_evolution_item_detail",detailPostData:{summon_id:""},sendType:"save",receivePresentConfirmMethod:"rest/evolution/receive_confirm/",receivePresentMethod:"rest/evolution/receive_present"}},item:p,shop:{detailTitleId:"shop_exchange_27",detailMethodName:"rest/item/detail/entrance",detailPostData:{},receivePresentConfirmMethod:"rest/item/detail/receive_confirm/",receivePresentMethod:"rest/item/detail/receive_present"},party:{detailTitleId:"party_pop_article_detail_1",detailMethodName:"rest/item/detail/entrance",detailPostData:{},receivePresentConfirmMethod:"rest/item/detail/receive_confirm/",receivePresentMethod:"rest/item/detail/receive_present"},arousal:{detailTitleId:"item_detail_1",detailMethodName:"rest/item/detail/entrance",detailPostData:{},receivePresentConfirmMethod:"rest/item/detail/receive_confirm/",receivePresentMethod:"rest/item/detail/receive_present"},hiddenweapon:p,bullet:p,companionparts:p,shield:p,domain_evoker:p,frontier:p,item_arousal:p,questlist:p,questmulti:p,lobby:p,coopraid:p,replicard:p,familiar:p,perfectionproof:p,quest:_.defaults({detailTitleId:"item_detail_1"},p)},r={ARTICLE:0,ARCHAIC:1,SHIELD:2,FAMILIAR:3,ALCHEMY:4},s={EXCHANGE_ARTICLE:["shop_exchange/article/","shop/archaic/article/","rest/shop_shield/selection/","rest/shop_familiar/selection/","rest/shop/alchemy/selection/"],PURCHASE:["shop_exchange/purchase/","shop/archaic/purchase/","rest/shop_shield/purchase/","rest/shop_familiar/purchase/","rest/shop/alchemy/purchase"]},t=c.extend({param:"",typeData:{},stackItemList:[],exchangeArticle:{},exchangeRenderData:{},popOenedFlg:!1,sendControlFlg:!1,SHOULD_UPDATE_LIST_TRIGGER:"easyItemExchange::shouldUpdateItemList",SET_CURRENT_PARAM_TRIGGER:"easyItemExchange::setCurrentParam",CLOSE_EASY_ITEM_EXCHANGE_POPUP:"closeEasyItemExchangePopup",updateItem:{},treasureShopType:r.ARTICLE,isTypeDataChanged:!1,events:{"tap .pop-confirm-error .btn-usual-cancel":"popRemove","tap .pop-article-detail.easy-item-exchange .btn-from-exchange":"prePopArticleSelect","tap .pop-article-detail.easy-item-exchange .btn-from-gift":"getPresentReceive","tap .pop-article-detail.easy-item-exchange .btn-from-quest":"onTapFromQuest","tap .pop-article-detail.easy-item-exchange .btn-usual-close":"popRemoveEasyResult",'tap .pop-article-select .btn-select-group:not(".selected")':"setSelectGroup","tap .pop-article-select .btn-usual-cancel":"popArticleDetail","tap .pop-article-select .btn-usual-ok":"popShowConfirm","tap .pop-easy-confirm .btn-usual-cancel":"backSelectGroup","change .pop-easy-confirm .num-set":"setBuyNum","tap .pop-easy-confirm .buy":"exchangeItem","tap .pop-easy-result .btn-usual-ok":"popRemoveEasyResult","tap .pop-easy-confirm-arcarum .btn-usual-cancel":"backSelectGroup","change .pop-easy-confirm-arcarum .num-set":"setBuyNumArcarum","tap .pop-easy-confirm-arcarum .buy":"exchangeItemArcarum","tap .pop-easy-confirm-casino .btn-usual-cancel":"backSelectGroup","change .pop-easy-confirm-casino .num-set":"setBuyNumCasino","tap .pop-easy-confirm-casino .buy":"exchangeItemCasino","tap .pop-present-confirm .btn-usual-cancel":"popArticleDetail","tap .pop-present-confirm .btn-get-present":"postReceivePresent","tap .pop-present-result .btn-usual-ok":"resultUpdate","tap .pop-present-result .btn-show-button":"slideButton"},initialize:function(a){this.content_bind(),this.param=a,this.setTypeData()},setTargetId:function(a){this.typeData.detailPostData[this.param.type+"_id"]=a},setTypeData:function(){this.typeData=o.EVOLUTION!==this.param.content?q[this.param.content]:q[this.param.content][this.param.type],this.typeData.detailTitle=k.getMessage(this.typeData.detailTitleId)},getArticleDetail:function(a,b,c,d){this.typeData.detailPostData.item_id=a,this.typeData.detailPostData.item_kind=b,this.additionalItemData=c||null;var f=new(e.extend({urlRoot:Game.baseUri+this.typeData.detailMethodName}));return this.stopListening(f,"sync"),this.listenToOnce(f,"sync",this.prePopArticleDetail),f.save(_.extend(d||{},this.typeData.detailPostData))},getArticleDetailForceQuestPop:function(a,b,c){this.typeData.detailPostData.item_id=a,this.typeData.detailPostData.item_kind=b,this.additionalItemData=c||null;var d=this,f=new(e.extend({urlRoot:Game.baseUri+this.typeData.detailMethodName}));return f.save(this.typeData.detailPostData).done(function(){d.setArticleForceQuestPop(f)})},setExchangeArticle:function(a){var b=a.toJSON(),c=this.createTreasureImagePath(b.image_id||b.item_id,+b.item_kind),d=this.additionalItemData||{};this.exchangeArticle={itemId:b.item_id,itemKind:+b.item_kind,itemName:b.name||d.itemName||"",itemNumber:b.item_number||d.itemNumber||0,itemPossessed:b.item_possessed||0===+b.item_possessed?b.item_possessed:d.itemPossessed||0,comment:b.comment||d.comment||"",evoComment:b.evo_comment||d.evoComment||"",presentTotalCount:b.present.total_count,enableFromQuest:b.view_treasurequest===!0,imagePath:c},+b.item_kind===i.ITEM_KIND.WEAPON&&(this.exchangeArticle.weaponKind=d.weaponKind,this.exchangeArticle.skills=d.skills),this.setItemList(b.item_list),this.giftTypeMoon=b.item_list.moon_shop_ids?+b.item_list.moon_shop_ids.gift_type:void 0},setItemList:function(a){this.isArchaicShop=!!a.archaic_shop_ids,this.treasureShopType=r.ARTICLE,a.shield_shop_ids?this.treasureShopType=r.SHIELD:a.familiar_shop_ids?this.treasureShopType=r.FAMILIAR:!a.article_shop_ids&&a.alchemy_shop_ids&&(this.treasureShopType=r.ALCHEMY),this.stackItemList=[a.archaic_shop_ids||a.shield_shop_ids||a.familiar_shop_ids||a.article_shop_ids||a.alchemy_shop_ids,a.mbp_hmbp_shop_ids,a.casino_prize_list_ids,a.arcarum_shop_ids,a.moon_shop_ids,a.gacha_bonus_shop_ids]},prePopArticleDetail:function(a){this.setExchangeArticle(a),this.popArticleDetail()},popArticleDetail:function(){var a=this.exchangeArticle.itemKind,b=this.exchangeArticle.itemId;this.popView=new g({className:"pop-article-detail easy-item-exchange",title:this.typeData.detailTitle,body:_.template($("#tpl-article-detail").html(),this.exchangeArticle),flagBtnClose:1,flagBtnOk:0,btnTreasure:0,treasureId:Game.footer&&Game.footer.mainView.validateTreasure({id:b,kind:a}),treasureName:this.exchangeArticle.itemName}),this.popView.render(),null===this.popView.options.treasureId&&this.popView.$el.find(".prt-treasure-registration").css("display","none"),this.popView.popShow()},getPresentReceive:function(){var a=new(d.extend({urlRoot:Game.baseUri+this.typeData.receivePresentConfirmMethod+this.exchangeArticle.itemId+"/"+this.exchangeArticle.itemKind}));this.stopListening(a,"sync"),this.listenToOnce(a,"sync",this.popPresentConfirm),a.fetch()},popPresentConfirm:function(a){this.presentReceive={},this.presentReceive=a.toJSON().present,this.presentReceive.totalCount=this.exchangeArticle.presentTotalCount,this.presentReceive.itemName=this.exchangeArticle.itemName,this.popView&&this.popView.popDelete(),this.popView=new g({className:"pop-present-confirm",title:k.getMessage("easy_exchange_11"),body:_.template($("#tpl-present-confirm").html(),this.presentReceive),flagBtnCancel:1,flagBtnOk:0}),this.popView.render().popShow()},postReceivePresent:function(){var a=this.presentReceive.infinity_ids||[],b=this.presentReceive.termed_ids||[],c=new(e.extend({urlRoot:Game.baseUri+this.typeData.receivePresentMethod}));this.stopListening(c,"sync"),this.listenToOnce(c,"sync",this.popPresentResult),c.set({infinity_ids:a,termed_ids:b}).save()},popPresentResult:function(){this.updateItem.itemId=+this.exchangeArticle.itemId,this.updateItem.itemKind=+this.exchangeArticle.itemKind,this.updateItem.number=+this.exchangeArticle.itemPossessed+ +this.exchangeArticle.presentTotalCount,this.popView=new g({className:"pop-present-result",title:k.getMessage("easy_exchange_12"),body:_.template($("#tpl-present-result").html(),this.presentReceive),flagBtnCancel:0,flagBtnOk:1}),this.popView.render().popShow()},slideButton:function(a){var b=$(a.currentTarget);return $("body").hasClass("android2")?(this.popView.$el.find(".btn-show-button").each(function(){"none"==$(this).css("display")&&$(this).css("display","block")}),b.css("display","none"),!0):(this.popView.$el.find(".btn-show-button").each(function(){$(this).hasClass("slide-btn")&&$(this).removeClass("slide-btn").addClass("slide-back")}),b.hasClass("slide-back")&&b.removeClass("slide-back"),void b.addClass("slide-btn"))},resultUpdate:function(){var a=this;this.postUpdateList(),this.listenToOnce(this.popView,"popEmptyEnd",function(){a.trigger(a.CLOSE_EASY_ITEM_EXCHANGE_POPUP)}),this.popRemove()},setSelectGroup:function(a){var b=$(a.currentTarget).data("select-id")-1;this.setRenderItem(b),this.renderPopArticleItemList()},prePopArticleSelect:function(){this.setRenderItem(),this.popArticleSelect()},popArticleSelect:function(){this.popView&&this.popView.popDelete({isHideMask:!1}),this.popView=new g({className:"pop-article-select",title:k.getMessage("easy_exchange_1"),body:_.template($("#tpl-article-select").html(),this.exchangeRenderData),flagBtnCancel:1,flagBtnOk:1,btnOkClassName:"prt-select-article"}),this.popView.render(),this.renderPopArticleItemList().done(this.popView.popShow.bind(this.popView))},renderPopArticleItemList:function(){var a={};_.each(this.stackItemList,function(b,c){a[c+1]=!b||!_.isUndefined(b.is_open)}),this.exchangeRenderData.grayFlgList=a;var b=!1;this.exchangeRenderData.selectListNo===m.casino&&this.exchangeRenderData.itemList&&this.exchangeRenderData.itemList.is_open&&+this.exchangeRenderData.itemList.possession_num>=this.exchangeRenderData.itemList.item_limit.max_item&&(b=!0),this.exchangeRenderData.isCasinoPossessionLimit=b;var c=0;this.exchangeRenderData.itemList&&_.isUndefined(this.exchangeRenderData.itemList.is_open)&&_.isUndefined(this.exchangeRenderData.itemList.is_deficient_material)&&!b&&(c=+this.exchangeRenderData.itemList.numbers[0]);var d=_.isUndefined(this.exchangeRenderData.itemList.is_get)===!1&&_.isUndefined(this.exchangeRenderData.itemList.is_get.max_item)===!1?this.exchangeRenderData.itemList.is_get.max_item:n;this.exchangeRenderData.isTreasureLimit=d<+this.exchangeRenderData.exchangeArticle.itemPossessed+c;var e=!!this.exchangeRenderData.itemList&&_.isUndefined(this.exchangeRenderData.itemList.is_deficient_material)&&_.isUndefined(this.exchangeRenderData.itemList.is_open)&&!this.exchangeRenderData.isTreasureLimit&&!b,f=this.popView.$el.find(".prt-select-article");f.toggleClass("btn-usual-ok",e),f.toggleClass("no-exchange",e===!1);var g=this,h=$.Deferred();return this.trigger("xhrStart"),require(["view/shop/exchange_list"],function(a){g.trigger("xhrEnd");var b=g.exchangeRenderData.itemList;b.needEquipment=a.prototype.getNeedEquipment(b),a.prototype.setRequireItemListImg([b]),$("#prt-article-select-group").empty().html(_.template($("#tpl-article-exchange-list").html(),g.exchangeRenderData)),g.exchangeRenderData.isTreasureLimit&&(c=0),g.popView.$el.find(".txt-after-num").html(+g.exchangeRenderData.exchangeArticle.itemPossessed+c);var d=+b.kind>=61&&+b.kind<=63,e=d&&1!==g.giftTypeMoon;g.popView.$el.find(".txt-moon-caution").toggleClass("show",e),h.resolve()}),h},setRenderItem:function(a){var b=null,c=null,d=function(a){return a&&_.isUndefined(a.is_open)===!0};if(_.isUndefined(a)===!0){for(var e=0;e<this.stackItemList.length;e++){var f=this.stackItemList[e];d(f)&&(c=null===c?e:c,_.isUndefined(f.is_deficient_material)&&(b=null===b?e:b))}b=null===b?c||0:b}else b=a;this.isArchaicShop&&(this.treasureShopType=b===m.treasure?r.ARCHAIC:r.ARTICLE),this.exchangeRenderData={selectListNo:b,itemList:this.stackItemList[b],listNo:b+1,exchangeArticle:this.exchangeArticle}},backSelectGroup:function(){this.popRemove(),this.setRenderItem(this.exchangeRenderData.selectListNo),this.popArticleSelect()},popShowConfirm:function(){if(this.popOpenedFlg)return!0;if(!this.sendControlFlg){this.sendControlFlg=!0,this.trigger("xhrStart");var a=this;this.exchangeRenderData.selectListNo===m.casino?this.renderPopCasinoConfirm():(this.security=new(d.extend({urlRoot:Game.baseUri+"security/csrf"})),this.stopListening(this.security,"change"),this.listenToOnce(this.security,"change",function(){a.exchangeRenderData.selectListNo===m.arcarum?a.createArcarumSecurity():a.createSecurity()}),this.security.fetch())}},createArcarumSecurity:function(){this.arcarumArticle=new(d.extend({urlRoot:Game.baseUri+"rest/arcarum/article/"+this.exchangeRenderData.itemList.id})),this.stopListening(this.arcarumArticle,"change"),this.listenToOnce(this.arcarumArticle,"change",this.renderPopArcarumConfirm),this.arcarumArticle.fetch()},renderPopArcarumConfirm:function(){var a=this.arcarumArticle.toJSON();a.maxPassportNum=this.maxPassportNum,a.possessionNum=this.exchangeRenderData.exchangeArticle.itemPossessed,a.needNum=this.exchangeRenderData.exchangeArticle.itemNumber,a.imagePath=this.createTreasureImagePath(a.image_path,+a.item_kind),this.popView=new g({className:"pop-easy-confirm-arcarum",title:k.getMessage("easy_exchange_1"),body:_.template($("#tpl-pop-confirm-arcarum").html(),a),flagBtnCancel:1,flagBtnOk:0}),this.popView.render(),this.setBuyNumArcarum(),this.popView.$el.find(".prt-popup-footer").append("<div class='btn-usual-text buy'>"+k.getMessage("easy_exchange_2")+"</div>"),this.popView.popShow(),this.sendControlFlg=!1,this.trigger("xhrEnd")},setBuyNumArcarum:function(){var a=+this.popView.$el.find(".num-set").children("option:selected").val(),b=this.exchangeRenderData.itemList.has_point-this.exchangeRenderData.itemList.point*a,c=+this.exchangeArticle.itemPossessed+a;this.popView.$el.find(".after-article").html(b),this.popView.$el.find(".txt-after-num").html(c)},exchangeItemArcarum:function(){this.trigger("xhrStart");var a=this.popView.$el.find(".num-set").children(":selected").val()||1;this.confirmPopHtml=this.popView.$el.find(".txt-popup-body").html(),this.popView.popRemove(),this.purchaseArcarum=new(PurchaseModel=e.extend({urlRoot:Game.baseUri+"rest/arcarum/purchase"})),this.purchaseArcarum.set({article_id:this.exchangeRenderData.itemList.id,num:+a}),this.stopListening(this.purchaseArcarum),this.listenToOnce(this.purchaseArcarum,"sync",this.renderResult),this.listenToOnce(this.purchaseArcarum,"error",this.errorMessage),this.purchaseArcarum.save()},createSecurity:function(){this.article=new(d.extend({urlRoot:Game.baseUri+s.EXCHANGE_ARTICLE[this.treasureShopType]+this.exchangeRenderData.itemList.id})),this.stopListening(this.article,"change"),this.listenToOnce(this.article,"change",this.renderPopShowConfirm),this.article.fetch()},renderPopShowConfirm:function(a){this.reRenderPopShowConfirm=this.renderPopShowConfirm.bind(this,a);var b=a.attributes;if(b.possessionNum=this.exchangeRenderData.exchangeArticle.itemPossessed,b.needNum=this.exchangeRenderData.exchangeArticle.itemNumber,b.event_type=this.event_type||1,b.isTreasurePop=1===this.exchangeRenderData.listNo,b.imagePath=this.createTreasureImagePath(b.image_path,+b.item_kind),j.isEnglish()===!0)for(var c=4,d=null,e=10261,f=1;c>=f;f++)d=b["article"+f],d&&e!==+b["article"+f].master.id&&(d.master.name=k.pluralMessage(d.master.name,+b["article"+f+"_number"]));b.exchangeText1=k.replaceMessage("exchange_text_1",{"%s":[b.remain_number]},b.remain_number);var h=this;require(["view/shop/exchange_list"],function(a){b.needEquipment=a.prototype.getNeedEquipment(b),a.prototype.setRequireItemListImg([b]);var c,d=+b.item_kind[0]===i.ITEM_KIND.SHIELD,e=+b.item_kind[0]===i.ITEM_KIND.FAMILIAR,f="pop-easy-confirm";d?(c=_.template($("#tpl-pop-confirm-shield").html(),b),f+=" shield"):e?(c=_.template($("#tpl-pop-confirm-familiar").html(),b),f+=" familiar"):c=_.template($("#tpl-pop-easy-confirm").html(),b),h.popView=new g({className:f,title:k.getMessage("easy_exchange_1"),body:c,flagBtnCancel:1,flagBtnOk:0}),h.popView.render();var j=+b.kind>=61&&+b.kind<=63,l=j&&1!==h.giftTypeMoon,m=b.article1_has_item_flg&&b.article2_has_item_flg&&b.article3_has_item_flg&&b.article4_has_item_flg&&!b.is_get.result;h.popView.$el.find(".txt-moon-caution").toggleClass("show",l),h.setBuyNum(),h.popView.$el.find(".prt-popup-footer").append(h.createExchangeButtonHtml(m,+b.item_kind)),h.popView.popShow(),h.sendControlFlg=!1,h.trigger("xhrEnd")})},setBuyNum:function(){var a=this,b=+(this.popView.$el.find(".num-set").children("option:selected").val()||1),c=this.popView.$el.find(".after-article");_.each(c,function(c,d){var e=d+1,f=+a.exchangeRenderData.itemList["article"+e].has_number,g=a.exchangeRenderData.itemList["article"+e+"_number"];_.isEmpty(g)===!1&&$(c).html(f-g*b)});var d=+this.exchangeArticle.itemPossessed+ +this.exchangeRenderData.itemList.numbers[0]*b;this.popView.$el.find(".txt-after-num").html(d),this.checkCaution(b)},exchangeItem:function(){this.trigger("xhrStart");var a=this.popView.$el.find(".num-set").children(":selected").val()||1;this.confirmPopHtml=this.popView.$el.find(".txt-popup-body").html(),this.popView.popRemove(),this.purchase=new(PurchaseModel=e.extend({urlRoot:Game.baseUri+s.PURCHASE[this.treasureShopType]})),this.purchase.set({article_id:this.exchangeRenderData.itemList.id,duplicate_key:l,num:a}),1==this.active_tab&&this.purchase.set({history_kind:2}),this.stopListening(this.purchase),this.listenToOnce(this.purchase,"sync",this.renderResult),this.listenToOnce(this.purchase,"error",this.errorMessage),this.purchase.save()},renderPopCasinoConfirm:function(){var a=+this.exchangeRenderData.itemList.item_limit.max_item-+this.exchangeRenderData.itemList.item_limit.item_cnt,b=Math.floor(this.exchangeRenderData.itemList.medal/this.exchangeRenderData.itemList.use_coin_number),c=null!=this.exchangeRenderData.itemList.remain_number?this.exchangeRenderData.itemList.remain_number:1;b>c&&(b=c),b>a&&(b=a);var d=this.createTreasureImagePath(this.exchangeRenderData.itemList.image_path,this.exchangeArticle.itemKind),e={id:this.exchangeRenderData.itemList.id,itemKind:this.exchangeArticle.itemKind,imagePath:d,itemName:this.exchangeArticle.itemName,possessionNum:this.exchangeArticle.itemPossessed,itemNumber:this.exchangeArticle.itemNumber,medal:+this.exchangeRenderData.itemList.medal,useCoinNumber:+this.exchangeRenderData.itemList.use_coin_number,maxNumber:b,remain_number:this.exchangeRenderData.itemList.remain_number,max_remain:this.exchangeRenderData.itemList.max_remain,max_unit_per_day:this.exchangeRenderData.itemList.max_unit_per_day,max_unit:this.exchangeRenderData.itemList.max_unit,max_unit_per_month:this.exchangeRenderData.itemList.max_unit_per_month,max_unit_per_week:this.exchangeRenderData.itemList.max_unit_per_week,numbers:+this.exchangeRenderData.itemList.numbers[0],exchangeText1:k.replaceMessage("exchange_text_1",{"%s":[this.exchangeRenderData.itemList.remain_number]},this.exchangeRenderData.itemList.remain_number)};this.popView=new g({className:"pop-easy-confirm-casino",title:k.getMessage("easy_exchange_1"),body:_.template($("#tpl-pop-confirm-casino").html(),e),flagBtnCancel:1,flagBtnOk:0}),this.popView.render(),this.setBuyNumCasino(),this.popView.$el.find(".prt-popup-footer").append(this.createExchangeButtonHtml(!this.exchangeRenderData.itemList.item_limit.result,+this.exchangeArticle.itemKind)),this.popView.popShow(),this.sendControlFlg=!1,this.trigger("xhrEnd")},setBuyNumCasino:function(){var a=+this.popView.$el.find(".num-set").children("option:selected").val()||1,b=this.exchangeRenderData.itemList.medal-this.exchangeRenderData.itemList.use_coin_number*a,c=+this.exchangeArticle.itemPossessed+ +this.exchangeRenderData.itemList.numbers[0]*a;this.popView.$el.find(".after-article").html(b),this.popView.$el.find(".txt-after-num").html(c)},exchangeItemCasino:function(){this.trigger("xhrStart");var a=this.popView.$el.find(".num-set").children(":selected").val()||1;this.exchangeCasinoNum=a,this.confirmPopHtml=this.popView.$el.find(".txt-popup-body").html();var b=new(e.extend({urlRoot:Game.baseUri+"casino/exchange"}));this.stopListening(b,"sync"),this.listenToOnce(b,"sync",this.renderResult),b.set({item_id:this.exchangeRenderData.itemList.id,num:a,duplicate_key:l}).save()},checkCaution:function(a){var b=this.article.toJSON();if(!_.isUndefined(b.max_remain)){var c=this.popView.$el.find(".txt-exchange-word.rate"),d=this.popView.$el.find(".txt-exchange-word.note"),e=a===+b.max_remain.number;c.toggleClass("show",e&&(b.is_existence_next||b.is_term_next)),d.toggleClass("show",e&&(b.is_existence_next||b.is_term_next))}},errorMessage:function(){this.popView=new g({className:"pop-confirm-error",title:k.getMessage("easy_exchange_3"),body:k.getMessage("easy_exchange_4"),flagBtnCancel:1,flagBtnOk:0}),this.popView.render().popShow(),this.trigger("xhrEnd")},renderResult:function(a){var b=a.toJSON();if(b.alert_popup)return this.popPurchaseFailureView||(this.popPurchaseFailureView=new h,this.addSubView(this.popPurchaseFailureView)),this.listenToOnce(this.popPurchaseFailureView,h.EVENT.CLOSE_PURCHASE_FAILURE,this.reRenderPopShowConfirm),this.popPurchaseFailureView.popForPurchaseFailure(b.alert_popup,this.article.attributes),void this.trigger("xhrEnd");this.reRenderPopShowConfirm=null;var c=b.article,d=+c.item_kind===i.ITEM_KIND.JP?k.getMessage("easy_exchange_jp"):k.getMessage("easy_exchange_7"),e=this.exchangeRenderData.selectListNo===m.casino?+this.exchangeCasinoNum:+b.purchase_number;this.exchangeRenderData.itemPossessed=+this.exchangeRenderData.exchangeArticle.itemPossessed+e;var j="pop-easy-result";switch(+c.item_kind){case i.ITEM_KIND.SHIELD:j+=" shield";break;case i.ITEM_KIND.FAMILIAR:j+=" familiar"}this.popView=new g({className:j,title:k.getMessage("easy_exchange_5"),body:this.confirmPopHtml,flagBtnOk:1,showEndCallback:function(){f.playGetTreasureSE()}}),this.popView.render(),this.popView.$el.find(".item-explain, .btn-buy-num, .btn-usual-text, .txt-exchange-word, .txt-easy-confirm, .prt-article-list").css("display","none"),_.isUndefined(c.kind)===!1&&+c.kind>=61&&+c.kind<=63&&1!==this.giftTypeMoon&&this.popView.$el.find(".txt-moon-result").addClass("show"),this.popView.$el.find(".prt-item-box").empty().html(_.template($("#tpl-easy-result-article").html(),this.exchangeRenderData)),this.additionalItemData&&(this.additionalItemData.itemPossessed||0===+this.additionalItemData.itemPossessed)&&(this.additionalItemData.itemPossessed=this.exchangeRenderData.itemPossessed);var l=this.popView.$el.find(".result");l.html(k.replaceMessage("easy_exchange_6",{"%s1":e,"%s2":d}));var n=this.popView.$el.find(".remain-num"),o=+n.attr("remain-num")-b.num;2==c.item_ids&&c.max_unit>0&&73!==+c.item_kind?(1==o?n.html(k.replaceMessage("easy_exchange_9",{"%s1":d,"%s2":o,"%s3":d})):n.html(k.replaceMessage("easy_exchange_8",{"%s1":d,"%s2":o,"%s3":d})),this.popView.$el.find(".pop-result .remain-max-num, .pop-result .txt-remark").html("")):n.remove(),this.popView.$el.find(".txt-max-exchange, .txt-unbreakable-item, .txt-attention-equipment").remove();var p=+this.pop_possession_num+ +b.num*+c.numbers[0];this.popView.$el.find(".item-possession").html(k.replaceMessage("easy_exchange_10",[p])),this.updateItem.itemId=+this.exchangeArticle.itemId,this.updateItem.itemKind=+this.exchangeArticle.itemKind,this.updateItem.number=+this.exchangeRenderData.itemPossessed,this.popView.popShow(),this.postUpdateList(),this.trigger("xhrEnd")},postUpdateList:function(){return this.trigger(this.SHOULD_UPDATE_LIST_TRIGGER,this.updateItem),this.treasureQuestView&&this.treasureQuestView.treasureRaidModel?void this.treasureQuestView.updatePurchaseNum(this.updateItem):void(this.updateItem={})},onTapFromQuest:function(){var a=this;this.listenToOnce(this.popView,"popEmptyEnd",function(){a.showQuestList()}),this.popRemove()},showQuestList:function(){var a=this;this.setTreasureQuestView().done(function(){a.trigger(a.SET_CURRENT_PARAM_TRIGGER),a.treasureQuestView.showGetTreasureQuest(a.exchangeArticle,!1)})},updateParentViewParam:function(a){this.treasureQuestView&&this.treasureQuestView.updateParentViewParam(a)},setTreasureQuestView:function(){var a=this,b=new $.Deferred;return this.treasureQuestView?b.resolve():(this.trigger("xhrStart"),require(["view/quest/sub/_sub_get_treasure_quest"],function(c){a.treasureQuestView=new c({el:a.el,content:a.param.content,category:a.param.type,baseId:a.param.baseId||null}),a.addSubView(a.treasureQuestView),a.listenToOnce(a.treasureQuestView,"closePopup",function(){a.isTypeDataChanged&&a.setTypeData(),a.trigger(a.CLOSE_EASY_ITEM_EXCHANGE_POPUP)}),a.listenTo(a.treasureQuestView,"shouldShowCollectTreasureDetail",function(b){a.param.content===o.EVOLUTION&&(a.typeData=p,a.typeData.detailTitle=k.getMessage(a.typeData.detailTitleId),a.isTypeDataChanged=!0),a.trigger("xhrStart"),a.getArticleDetail(b.itemId,b.itemKind,{itemNumber:b.itemNumber}).then(a.trigger.bind(a,"xhrEnd"))}),a.listenToOnce(a.treasureQuestView,c.EVENT_QUEST_START_CANCELED,function(){a.removeTreasureQuestView()}),b.resolve()})),b.promise()},setArticleForceQuestPop:function(a){this.setExchangeArticle(a),this.showQuestList()},popRemove:function(){this.popView&&this.popView.popRemove()},popRemoveEasyResult:function(){var a=this;this.listenToOnce(this.popView,"popEmptyEnd",function(){return a.treasureQuestView&&a.treasureQuestView.treasureRaidModel&&a.shouldReopenPopTreasureRaid()?void a.treasureQuestView.popTreasureRaid(a.treasureQuestView.treasureRaidModel):void a.trigger(a.CLOSE_EASY_ITEM_EXCHANGE_POPUP)}),this.popRemove()},createTreasureImagePath:function(a,b){switch(b){case 1:case 37:return"assets/weapon/m/"+a+".jpg";case 2:case 38:return"assets/summon/m/"+a+".jpg";case i.ITEM_KIND.MONEY:return"assets/item/normal/m/lupi.jpg";case i.ITEM_KIND.STONE:return"assets/item/normal/m/gem.jpg";case 10:return"assets/item/article/m/"+a+".jpg";case 17:return"assets/item/evolution/m/"+a+".jpg";case 19:return"assets/item/normal/m/jp.jpg";case i.ITEM_KIND.SHIELD:return"assets/shield/m/"+a+".jpg";case i.ITEM_KIND.FAMILIAR:return"assets/familiar/m/"+a+".jpg"}},createExchangeButtonHtml:function(a,b){var c=$("<div></div>");if(!a)return c.addClass("btn-usual-text buy").text(k.getMessage("easy_exchange_2")).prop("outerHTML");switch(b){case 1:case 37:return c.addClass("btn-usual-enhance").attr("data-href","enhancement/weapon/base").prop("outerHTML");case 2:case 38:return c.addClass("btn-usual-enhance").attr("data-href","enhancement/summon/base").prop("outerHTML");default:return c.addClass("btn-usual-text buy").text(k.getMessage("easy_exchange_2")).prop("outerHTML")}},getWeaponDetail:function(a,b){this.trigger("xhrStart");var c=new(e.extend({urlRoot:Game.baseUri+"result/detail"}));this.listenToOnce(c,"sync",function(c){var d={weaponKind:c.attributes.data.kind,skills:_.filter(c.attributes.data.skill,function(a){return!_.isEmpty(a)})};this.getArticleDetail(a,b,d),this.trigger("xhrEnd")}.bind(this)),c.set({item_id:a,item_kind:b}).save()},shouldReopenPopTreasureRaid:function(){var a=this.treasureQuestView.treasureRaidModel.toJSON(),b=this;return _.some(a.treasure_id,function(c,d){return+c===+b.exchangeArticle.itemId&&+a.treasure_kind[d]===+b.exchangeArticle.itemKind})},removeTreasureQuestView:function(){this.stopListening(this.treasureQuestView),this.treasureQuestView.content_close(!0),this.removeSubView(this.treasureQuestView),this.treasureQuestView=null}},{CONTENT_NAME:o});return t});